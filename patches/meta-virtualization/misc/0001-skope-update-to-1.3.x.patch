From b22003973b19f1ee03337b9a47839563c9d3d19e Mon Sep 17 00:00:00 2001
From: Bruce Ashfield <bruce.ashfield@gmail.com>
Date: Tue, 25 May 2021 13:49:14 -0400
Subject: [PATCH] skope: update to 1.3.x

Updating skopeo to the 1.3.x series. Along with the version bump, we
patch the Makefile to stop using gpgme-config and instead using
pkg-config, since OE taints gpgme-config and the build will break if
we call it directly.

Signed-off-by: Bruce Ashfield <bruce.ashfield@gmail.com>
---
 ...e-pkg-config-instead-of-gpgme-config.patch | 35 +++++++++++++++++++
 recipes-containers/skopeo/skopeo_git.bb       |  9 +++--
 2 files changed, 41 insertions(+), 3 deletions(-)
 create mode 100644 recipes-containers/skopeo/files/0001-Makefile-use-pkg-config-instead-of-gpgme-config.patch

diff --git a/recipes-containers/skopeo/files/0001-Makefile-use-pkg-config-instead-of-gpgme-config.patch b/recipes-containers/skopeo/files/0001-Makefile-use-pkg-config-instead-of-gpgme-config.patch
new file mode 100644
index 0000000..f12734c
--- /dev/null
+++ b/recipes-containers/skopeo/files/0001-Makefile-use-pkg-config-instead-of-gpgme-config.patch
@@ -0,0 +1,35 @@
+From 4f60614b51df50f5d28495cf2e270dd6ab5fea7d Mon Sep 17 00:00:00 2001
+From: Bruce Ashfield <bruce.ashfield@gmail.com>
+Date: Tue, 25 May 2021 13:42:56 -0400
+Subject: [PATCH] Makefile: use pkg-config instead of gpgme-config
+
+OE taints gpgme-config to produce the following flag when called:
+
+   --should-not-have-used-/usr/bin/gpgme-config
+
+Which breaks the build. We change to use pkg-config, and skopeo
+builds as it did before.
+
+Upstream-Status: inappropriate OE specific
+
+Signed-off-by: Bruce Ashfield <bruce.ashfield@gmail.com>
+---
+ Makefile | 2 +-
+ 1 file changed, 1 insertion(+), 1 deletion(-)
+
+diff --git a/src/import/Makefile b/src/import/Makefile
+index 6bacd12e..8a94b236 100644
+--- a/src/import/Makefile
++++ b/src/import/Makefile
+@@ -8,7 +8,7 @@ export GOPROXY=https://proxy.golang.org
+ # supports only pkg-config, not general shell scripts, and gpgme does not install a pkg-config file.
+ # If gpgme is not installed or gpgme-config canâ€™t be found for other reasons, the error is silently ignored
+ # (and the user will probably find out because the cgo compilation will fail).
+-GPGME_ENV := CGO_CFLAGS="$(shell gpgme-config --cflags 2>/dev/null)" CGO_LDFLAGS="$(shell gpgme-config --libs 2>/dev/null)"
++GPGME_ENV := CGO_CFLAGS="$(shell pkg-config gpgme --cflags 2>/dev/null)" CGO_LDFLAGS="$(shell pkg-config gpgme --libs 2>/dev/null)"
+ 
+ # Normally empty, DESTDIR can be used to relocate the entire install-tree
+ DESTDIR ?=
+-- 
+2.19.1
+
diff --git a/recipes-containers/skopeo/skopeo_git.bb b/recipes-containers/skopeo/skopeo_git.bb
index 05baefb..2c29246 100644
--- a/recipes-containers/skopeo/skopeo_git.bb
+++ b/recipes-containers/skopeo/skopeo_git.bb
@@ -20,13 +20,14 @@ RDEPENDS_${PN} = " \
 "
 
 SRC_URI = " \
-    git://github.com/containers/skopeo;branch=release-1.2 \
+    git://github.com/containers/skopeo;branch=master \
+    file://0001-Makefile-use-pkg-config-instead-of-gpgme-config.patch \
     file://storage.conf \
     file://registries.conf \
 "
 
-SRCREV = "e7880c4a8991966f16e367f085d42375ad70197e"
-PV = "v1.2.3-dev+git${SRCPV}"
+SRCREV = "8efffce8befc2de87670ba75d6c86ada61e869fd"
+PV = "v1.3.0+git${SRCPV}"
 GO_IMPORT = "import"
 
 S = "${WORKDIR}/git"
@@ -63,6 +64,8 @@ do_compile() {
 	export CGO_LDFLAGS="${BUILDSDK_LDFLAGS} --sysroot=${STAGING_DIR_TARGET}"
 	cd ${S}/src/import
 
+	export GO111MODULE=off
+
 	oe_runmake bin/skopeo
 }
 
-- 
2.25.1

