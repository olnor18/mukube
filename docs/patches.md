# Patches
All changes upstreamed, submitted upstream or cherry-picked from upstream should be applied with a patch file and added to the list below. This way it is much easier to track the changes and drop them as we update to newer versions where they are included.

## Current patches
| Patch  | Project | Status | Description |
| - | - | - | - |
| [`0001-Doing-patch-of-build.patch`](../meta-k8s-setup/recipes-containers/runc/files/0001-Doing-patch-of-build.patch) | [meta-virtualization](https://git.yoctoproject.org/cgit/cgit.cgi/meta-virtualization/) | local patch | Unknown |
| [`systemd_247.6-249.3.patch`](../patches/poky/systemd/systemd_247.6-249.3.patch) | [poky](https://git.yoctoproject.org/cgit/cgit.cgi/poky) | cherry-picked | Update `systemd` for [TPM support added in v248](http://0pointer.net/blog/unlocking-luks2-volumes-with-tpm2-fido2-pkcs11-security-hardware-on-systemd-248.html). `git diff` between the `hardknott` ([b89bb2651d](https://git.yoctoproject.org/cgit/cgit.cgi/poky/commit/?id=b89bb2651d7c01084c84c40c3095ef93b36807fb)) and `master` branch ([a5b257006b](https://git.yoctoproject.org/cgit/cgit.cgi/poky/commit/?id=a5b257006b2c480d86e09909cdafb3c8ba05b863)) for the `systemd` recipe |
| [`0001-add-start-swtpm-script.patch`](../patches/poky/misc/0001-add-start-swtpm-script.patck) | [poky](https://git.yoctoproject.org/cgit/cgit.cgi/poky) | local patch | Adds our script, which starts swtpm to use with qemu, to the poky scrips dir.  |
| [`0001-gpt-auto-generator-Use-volatile-root-by-default-and-.patch`](../meta-k8s-setup/recipes-core/systemd/systemd/0001-gpt-auto-generator-Use-volatile-root-by-default-and-.patch) | [systemd](https://github.com/systemd/systemd) | [upstreamed](https://github.com/systemd/systemd/commit/b00651cf433012dea0c32db99af7cd0c542ea066) | Make [`systemd-gpt-auto-generator`](https://www.freedesktop.org/software/systemd/man/systemd-gpt-auto-generator.html) work with `/run/systemd/volatile-root`. This is needed as systemd can't find the original root partition due to [`ramrootfs`](../meta-k8s-setup/recipes-core/initrdscripts/initramfs-framework/ramrootfs) |
| [`0001-repart-don-t-prefix-sysroot-twice.patch`](../meta-k8s-setup/recipes-core/systemd/systemd/0001-repart-don-t-prefix-sysroot-twice.patch) | [systemd](https://github.com/systemd/systemd) | [cherry-picked](https://github.com/systemd/systemd/commit/6bbae9f8b33081b3647b7314497067e78363adc1) | Required for the next patch to apply cleanly |
| [`0001-repart-Support-volatile-root-for-finding-the-root-pa.patch`](../meta-k8s-setup/recipes-core/systemd/systemd/0001-repart-Support-volatile-root-for-finding-the-root-pa.patch) | [systemd](https://github.com/systemd/systemd) | [upstreamed](https://github.com/systemd/systemd/commit/54632d2ea405e9df9ca9c3c469c7d0feb3a85323) | Make [`systemd-repart`](https://www.freedesktop.org/software/systemd/man/systemd-repart.html) work with `/run/systemd/volatile-root`. This is needed as systemd can't find the original root partition due to [`ramrootfs`](../meta-k8s-setup/recipes-core/initrdscripts/initramfs-framework/ramrootfs) |
| [`0001-wic-Add-extra-space-argument.patch`](../patches/poky/misc/0001-wic-Add-extra-space-argument.patch) | [openembedded-core](https://git.openembedded.org/openembedded-core/) | [upstreamed](https://git.openembedded.org/openembedded-core/commit/?id=f81b188bcf5aa18746fd622eb7b5c0dcb0b5c93d) | Allow extra space to be added after the last partition, which makes it easier to test [`systemd-repart`](https://www.freedesktop.org/software/systemd/man/systemd-repart.html) in QEMU |
| [`0001-Convert-to-new-override-syntax.patch`](../patches/poky/misc/0001-Convert-to-new-override-syntax.patch) | [openembedded-core](https://git.openembedded.org/openembedded-core/) | [cherry-picked](https://git.openembedded.org/openembedded-core/commit/meta/classes/image_types_wic.bbclass?id=42344347be29f0997cc2f7636d9603b1fe1875ae) | Required for the next patch but one to apply cleanly. Created with `git format-patch -1 42344347be meta/classes/image_types_wic.bbclass` |
| [`0001-image_types_wic.bbclass-alphabetize-list-of-WICVARS.patch`](../patches/poky/misc/0001-image_types_wic.bbclass-alphabetize-list-of-WICVARS.patch) | [openembedded-core](https://git.openembedded.org/openembedded-core/) | [cherry-picked](https://git.openembedded.org/openembedded-core/commit/?id=aec6fcb98c7dabf16779efb333be09d73d9f4ee0) | Required for the next patch to apply cleanly |
| [`v3-0001-wic-bootimg-efi-Add-Unified-Kernel-Image-option.patch`](../patches/poky/misc/v3-0001-wic-bootimg-efi-Add-Unified-Kernel-Image-option.patch) | [openembedded-core](https://git.openembedded.org/openembedded-core/) | [submitted upstream](https://lists.openembedded.org/g/openembedded-core/topic/patch_v3_wic_bootimg_efi/85923375) | Add support to WIC for creating a [Unified Kernel Image](https://systemd.io/BOOT_LOADER_SPECIFICATION/#type-2-efi-unified-kernel-images), which is useful for implementing Secure Boot |
| [`0001-systemd-Add-repart-PACKAGECONFIG.patch`](../patches/poky/systemd/0001-systemd-Add-repart-PACKAGECONFIG.patch) | [openembedded-core](https://git.openembedded.org/openembedded-core/) | [upstreamed](https://git.openembedded.org/openembedded-core/commit/?id=a9fb51b75d4536d13734d91222bb0bc612555ae2) | Add `PACKAGECONFIG` for enabling [`systemd-repart`](https://www.freedesktop.org/software/systemd/man/systemd-repart.html) |
| [`0001-systemd-Add-homed-PACKAGECONFIG.patch`](../patches/poky/systemd/0001-systemd-Add-homed-PACKAGECONFIG.patch) | [openembedded-core](https://git.openembedded.org/openembedded-core/) | [upstreamed](https://git.openembedded.org/openembedded-core/commit/?id=fff339b5bd7789db5d0c024fc84490ac17fa4fe9) | Fix QA issue when `repart`, `openssl` and `cryptsetup` are enabled |
| [`0001-systemd-Add-tpm2-PACKAGECONFIG.patch`](../patches/poky/systemd/0001-systemd-Add-tpm2-PACKAGECONFIG.patch) | [openembedded-core](https://git.openembedded.org/openembedded-core/) | [upstreamed](https://git.openembedded.org/openembedded-core/commit/?id=7b7dfbfaedde775add3be7a3cb44b115d8ec5036) | Add PACKAGECONFIG for enabling tpm2 support |
| [`0001-libtpm-update-to-0.8.7.patch`](../patches/meta-security/misc/0001-libtpm-update-to-0.8.7.patch) | [meta-security](https://git.yoctoproject.org/cgit/cgit.cgi/meta-security/) | [submitted upstream](https://lists.yoctoproject.org/g/yocto/topic/meta_security_patch/85897588) | Update `libtpms` to 0.8.7 |
| [`0001-meta-tpm-Convert-to-new-override-syntax.patch`](../patches/meta-security/misc/0001-meta-tpm-Convert-to-new-override-syntax.patch) | [meta-security](https://git.yoctoproject.org/cgit/cgit.cgi/meta-security/) | [cherry-picked](https://git.yoctoproject.org/cgit/cgit.cgi/meta-security/commit/meta-tpm/recipes-tpm/swtpm?id=c7632b927c4cb31d77caebe1390da21c630cfe0e) | Required for the next patch to apply cleanly. Created with `git format-patch -1 c7632b9 meta-tpm/recipes-tpm/swtpm/` |
| [`0001-swtpm-update-to-0.6.1.patch`](../patches/meta-security/misc/0001-swtpm-update-to-0.6.1.patch) | [meta-security](https://git.yoctoproject.org/cgit/cgit.cgi/meta-security/) | [submitted upstream](https://lists.yoctoproject.org/g/yocto/topic/meta_security_patch_swtpm/85898116) | Update `swtpm` to 0.6.1 |
| [`0001-skopeo-bump-to-1.2.3-dev.patch`](../patches/meta-virtualization/misc/0001-skopeo-bump-to-1.2.3-dev.patch) | [meta-virtualization](https://git.yoctoproject.org/cgit/cgit.cgi/meta-virtualization/) | [cherry-picked](https://git.yoctoproject.org/cgit/cgit.cgi/meta-virtualization/commit/?id=ce6815f6ce4756323736e6d2ec470dc94b7d9486) | Required for the next patch to apply cleanly |
| [`0001-skope-update-to-1.3.x.patch`](../patches/meta-virtualization/misc/0001-skope-update-to-1.3.x.patch) | [meta-virtualization](https://git.yoctoproject.org/cgit/cgit.cgi/meta-virtualization/) | [cherry-picked](https://git.yoctoproject.org/cgit/cgit.cgi/meta-virtualization/commit/?id=b22003973b19f1ee03337b9a47839563c9d3d19e) | Seems to fix a issue where Skopeo is trying to link to the host's `libgpgme.so` |
| [`0001-skopeo-add-native-and-nativesdk-support.patch`](../patches/meta-virtualization/misc/0001-skopeo-add-native-and-nativesdk-support.patch) | [meta-virtualization](https://git.yoctoproject.org/cgit/cgit.cgi/meta-virtualization/) | [cherry-picked](https://git.yoctoproject.org/cgit/cgit.cgi/meta-virtualization/commit/?id=bbf7ddbe0269cf3cb6d8dcae4495d7983d256016) | Add `native` and `nativesdk` support |
| [`0001-skopeo-fix-native-skopeo-failed-if-no-libdevmapper.s.patch`](../patches/meta-virtualization/misc/0001-skopeo-fix-native-skopeo-failed-if-no-libdevmapper.s.patch) | [meta-virtualization](https://git.yoctoproject.org/cgit/cgit.cgi/meta-virtualization/) | [cherry-picked](https://git.yoctoproject.org/cgit/cgit.cgi/meta-virtualization/commit/?id=c1bd680e12e56f2eea235d22548e0cf85185ab53) | Fix issue with the `native` support if no `libdevmapper.so.1.02` on host |
| [`0001-skopeo-switch-to-main-branch.patch`](../patches/meta-virtualization/misc/0001-skopeo-switch-to-main-branch.patch) | [meta-virtualization](https://git.yoctoproject.org/cgit/cgit.cgi/meta-virtualization/) | [cherry-picked](https://git.yoctoproject.org/cgit/cgit.cgi/meta-virtualization/commit/?id=ae44f7f5040a26abdc56c25b43b6a8bf13ae7535) | Fix source retrieval issue after Skopeo has migrated from `master` to `main` |

## Patches carried in the past
This table contains patches submitted by us to upstream which we are no longer carrying, either because we have updated to a version where they are included or we don't need the change anymore.

| Patch  | Project | Status | Description |
| - | - | - | - |
| [`0001-cryptsetup-Add-runtime-dependency-on-lvm2-udevrules-.patch`](../patches/meta-openembedded/misc/0001-cryptsetup-Add-runtime-dependency-on-lvm2-udevrules-.patch) |  [meta-openembedded](https://git.openembedded.org/meta-openembedded) | [upstreamed](https://git.openembedded.org/meta-openembedded/commit/?id=9b02aa12203adc6219a6e0f8b114058e2487b59f) | Fix issue where `cryptsetup luksOpen`/[`systemd-repart`](https://www.freedesktop.org/software/systemd/man/systemd-repart.html) hangs forever |
