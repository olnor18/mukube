# Patches
All changes upstreamed, submitted upstream or cherry-picked from upstream should be applied with a patch file and added to the list below. This way it is much easier to track the changes and drop them as we update to newer versions where they are included.

## Current patches
| Patch  | Project | Status | Description |
| - | - | - | - |
| [`0001-add-start-swtpm-script.patch`](../patches/poky/misc/0001-add-start-swtpm-script.patck) | [poky](https://git.yoctoproject.org/cgit/cgit.cgi/poky) | local patch | Adds our script, which starts swtpm to use with qemu, to the poky scrips dir.  |
| [`0001-gpt-auto-generator-Use-volatile-root-by-default-and-.patch`](../meta-k8s-setup/recipes-core/systemd/systemd/0001-gpt-auto-generator-Use-volatile-root-by-default-and-.patch) | [systemd](https://github.com/systemd/systemd) | [upstreamed](https://github.com/systemd/systemd/commit/b00651cf433012dea0c32db99af7cd0c542ea066) | Make [`systemd-gpt-auto-generator`](https://www.freedesktop.org/software/systemd/man/systemd-gpt-auto-generator.html) work with `/run/systemd/volatile-root`. This is needed as systemd can't find the original root partition due to [`ramrootfs`](../meta-k8s-setup/recipes-core/initrdscripts/initramfs-framework/ramrootfs) |
| [`0001-repart-don-t-prefix-sysroot-twice.patch`](../meta-k8s-setup/recipes-core/systemd/systemd/0001-repart-don-t-prefix-sysroot-twice.patch) | [systemd](https://github.com/systemd/systemd) | [cherry-picked](https://github.com/systemd/systemd/commit/6bbae9f8b33081b3647b7314497067e78363adc1) | Required for the next patch to apply cleanly |
| [`0001-repart-Support-volatile-root-for-finding-the-root-pa.patch`](../meta-k8s-setup/recipes-core/systemd/systemd/0001-repart-Support-volatile-root-for-finding-the-root-pa.patch) | [systemd](https://github.com/systemd/systemd) | [upstreamed](https://github.com/systemd/systemd/commit/54632d2ea405e9df9ca9c3c469c7d0feb3a85323) | Make [`systemd-repart`](https://www.freedesktop.org/software/systemd/man/systemd-repart.html) work with `/run/systemd/volatile-root`. This is needed as systemd can't find the original root partition due to [`ramrootfs`](../meta-k8s-setup/recipes-core/initrdscripts/initramfs-framework/ramrootfs) |
| [`0001-CRI-O-Remove-containerd-as-RDEPENDS.patch`](../patches/meta-virtualization/misc/0001-CRI-O-Remove-containerd-as-RDEPENDS.patch) | [meta-virtualization](https://git.yoctoproject.org/cgit/cgit.cgi/meta-virtualization/) | local patch | Removes containerd as a dependency in cri-o |

## Patches carried in the past
This table contains patches submitted by us to upstream which we are no longer carrying, either because we have updated to a version where they are included or we don't need the change anymore.

| Patch  | Project | Status | Description |
| - | - | - | - |
| [`0001-cryptsetup-Add-runtime-dependency-on-lvm2-udevrules-.patch`](../patches/meta-openembedded/misc/0001-cryptsetup-Add-runtime-dependency-on-lvm2-udevrules-.patch) |  [meta-openembedded](https://git.openembedded.org/meta-openembedded) | [upstreamed](https://git.openembedded.org/meta-openembedded/commit/?id=9b02aa12203adc6219a6e0f8b114058e2487b59f) | Fix issue where `cryptsetup luksOpen`/[`systemd-repart`](https://www.freedesktop.org/software/systemd/man/systemd-repart.html) hangs forever |
| [`0001-wic-Add-extra-space-argument.patch`](../patches/poky/misc/0001-wic-Add-extra-space-argument.patch) | [openembedded-core](https://git.openembedded.org/openembedded-core/) | [upstreamed](https://git.openembedded.org/openembedded-core/commit/?id=f81b188bcf5aa18746fd622eb7b5c0dcb0b5c93d) | Allow extra space to be added after the last partition, which makes it easier to test [`systemd-repart`](https://www.freedesktop.org/software/systemd/man/systemd-repart.html) in QEMU |
| [`0001-wic-bootimg-efi-Add-Unified-Kernel-Image-option.patch`](../patches/poky/misc/0001-wic-bootimg-efi-Add-Unified-Kernel-Image-option.patch) | [openembedded-core](https://git.openembedded.org/openembedded-core/) | [upstreamed](https://git.openembedded.org/openembedded-core/commit/?id=b0573f240525df561ddef6e47cb285b217d38487) | Add support to WIC for creating a [Unified Kernel Image](https://systemd.io/BOOT_LOADER_SPECIFICATION/#type-2-efi-unified-kernel-images), which is useful for implementing Secure Boot |
| [`0001-systemd-Add-repart-PACKAGECONFIG.patch`](../patches/poky/systemd/0001-systemd-Add-repart-PACKAGECONFIG.patch) | [openembedded-core](https://git.openembedded.org/openembedded-core/) | [upstreamed](https://git.openembedded.org/openembedded-core/commit/?id=a9fb51b75d4536d13734d91222bb0bc612555ae2) | Add `PACKAGECONFIG` for enabling [`systemd-repart`](https://www.freedesktop.org/software/systemd/man/systemd-repart.html) |
| [`0001-systemd-Add-homed-PACKAGECONFIG.patch`](../patches/poky/systemd/0001-systemd-Add-homed-PACKAGECONFIG.patch) | [openembedded-core](https://git.openembedded.org/openembedded-core/) | [upstreamed](https://git.openembedded.org/openembedded-core/commit/?id=fff339b5bd7789db5d0c024fc84490ac17fa4fe9) | Fix QA issue when `repart`, `openssl` and `cryptsetup` are enabled |
| [`0001-systemd-Add-tpm2-PACKAGECONFIG.patch`](../patches/poky/systemd/0001-systemd-Add-tpm2-PACKAGECONFIG.patch) | [openembedded-core](https://git.openembedded.org/openembedded-core/) | [upstreamed](https://git.openembedded.org/openembedded-core/commit/?id=7b7dfbfaedde775add3be7a3cb44b115d8ec5036) | Add PACKAGECONFIG for enabling tpm2 support |
| [`0001-ovmf-add-TPM-PACKAGECONFIG-and-enable-if-tpm-is-in-M.patch`](../patches/poky/misc/0001-ovmf-add-TPM-PACKAGECONFIG-and-enable-if-tpm-is-in-M.patch) | [openembedded-core](https://git.openembedded.org/openembedded-core/) | [upstreamed](https://git.openembedded.org/openembedded-core/commit/?id=e71280883c217d86b4636da6e549334183f1aff7) | Enable OVMF's TPM support automatically when tpm{,2} in MACHINE_FEATURES |
| [`0001-libtpm-update-to-0.8.7.patch`](../patches/meta-security/misc/0001-libtpm-update-to-0.8.7.patch) | [meta-security](https://git.yoctoproject.org/cgit/cgit.cgi/meta-security/) | [upstreamed](https://git.yoctoproject.org/cgit/cgit.cgi/meta-security/commit/?id=36739546691c57ed8956e662de7e0c7247d4b9b8) | Update `libtpms` to 0.8.7 |
| [`0001-swtpm-update-to-0.6.1.patch`](../patches/meta-security/misc/0001-swtpm-update-to-0.6.1.patch) | [meta-security](https://git.yoctoproject.org/cgit/cgit.cgi/meta-security/) | [upstreamed](https://git.yoctoproject.org/cgit/cgit.cgi/meta-security/commit/?id=01bdc2918cfe74da7d6615711d5544b505429ddc) | Update `swtpm` to 0.6.1 |
