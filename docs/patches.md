# Patches
All changes upstreamed, submitted upstream or cherry-picked from upstream should be applied with a patch file and added to the list below. This way it is much easier to track the changes and drop them as we update to newer versions where they are included.

## Current patches
| Patch  | Project | Status | Description |
| - | - | - | - |
| [`0001-Doing-patch-of-build.patch`](../meta-k8s-setup/recipes-containers/runc/files/0001-Doing-patch-of-build.patch) | [meta-virtualization](https://git.yoctoproject.org/cgit/cgit.cgi/meta-virtualization/) | local patch | Unknown |
| [`systemd_247.6-249.3.patch`](../patches/poky/systemd/systemd_247.6-249.3.patch) | [poky](https://git.yoctoproject.org/cgit/cgit.cgi/poky) | cherry-picked | Update `systemd` for [TPM support added in v248](http://0pointer.net/blog/unlocking-luks2-volumes-with-tpm2-fido2-pkcs11-security-hardware-on-systemd-248.html). `git diff` between the `hardknott` ([b89bb2651d](https://git.yoctoproject.org/cgit/cgit.cgi/poky/commit/?id=b89bb2651d7c01084c84c40c3095ef93b36807fb)) and `master` branch ([a5b257006b](https://git.yoctoproject.org/cgit/cgit.cgi/poky/commit/?id=a5b257006b2c480d86e09909cdafb3c8ba05b863)) for the `systemd` recipe |
| [`0001-gpt-auto-generator-Use-volatile-root-by-default-and-.patch`](../meta-k8s-setup/recipes-core/systemd/systemd/0001-gpt-auto-generator-Use-volatile-root-by-default-and-.patch) | [systemd](https://github.com/systemd/systemd) | [upstreamed](https://github.com/systemd/systemd/commit/b00651cf433012dea0c32db99af7cd0c542ea066) | Make [`systemd-gpt-auto-generator`](https://www.freedesktop.org/software/systemd/man/systemd-gpt-auto-generator.html) work with `/run/systemd/volatile-root`. This is needed as systemd can't find the original root partition due to [`ramrootfs`](../meta-k8s-setup/recipes-core/initrdscripts/initramfs-framework/ramrootfs) |
| [`0001-repart-don-t-prefix-sysroot-twice.patch`](../meta-k8s-setup/recipes-core/systemd/systemd/0001-repart-don-t-prefix-sysroot-twice.patch) | [systemd](https://github.com/systemd/systemd) | [cherry-picked](https://github.com/systemd/systemd/commit/6bbae9f8b33081b3647b7314497067e78363adc1) | Required for the next patch to apply cleanly |
| [`0001-repart-Support-volatile-root-for-finding-the-root-pa.patch`](../meta-k8s-setup/recipes-core/systemd/systemd/0001-repart-Support-volatile-root-for-finding-the-root-pa.patch) | [systemd](https://github.com/systemd/systemd) | [upstreamed](https://github.com/systemd/systemd/commit/54632d2ea405e9df9ca9c3c469c7d0feb3a85323) | Make [`systemd-repart`](https://www.freedesktop.org/software/systemd/man/systemd-repart.html) work with `/run/systemd/volatile-root`. This is needed as systemd can't find the original root partition due to [`ramrootfs`](../meta-k8s-setup/recipes-core/initrdscripts/initramfs-framework/ramrootfs) |
| [`0001-wic-Add-extra-space-argument.patch`](../patches/poky/misc/0001-wic-Add-extra-space-argument.patch) | [openembedded-core](https://git.openembedded.org/openembedded-core/) | [upstreamed](https://git.openembedded.org/openembedded-core/commit/?id=f81b188bcf5aa18746fd622eb7b5c0dcb0b5c93d) | Allow extra space to be added after the last partition, which makes it easier to test [`systemd-repart`](https://www.freedesktop.org/software/systemd/man/systemd-repart.html) in QEMU |
| [`0001-wic-bootimg-efi-Add-Unified-Kernel-Image-option.patch`](../patches/poky/misc/0001-wic-bootimg-efi-Add-Unified-Kernel-Image-option.patch) | [openembedded-core](https://git.openembedded.org/openembedded-core/) | [submitted upstream](https://lists.openembedded.org/g/openembedded-core/topic/patch_v2_wic_bootimg_efi/85570082) | Add support to WIC for creating a [Unified Kernel Image](https://systemd.io/BOOT_LOADER_SPECIFICATION/#type-2-efi-unified-kernel-images), which is useful for implementing Secure Boot |
| [`0001-systemd-Add-repart-PACKAGECONFIG.patch`](../patches/poky/systemd/0001-systemd-Add-repart-PACKAGECONFIG.patch) | [openembedded-core](https://git.openembedded.org/openembedded-core/) | [upstreamed](https://git.openembedded.org/openembedded-core/commit/?id=a9fb51b75d4536d13734d91222bb0bc612555ae2) | Add `PACKAGECONFIG` for enabling [`systemd-repart`](https://www.freedesktop.org/software/systemd/man/systemd-repart.html) |
| [`0001-systemd-Add-homed-PACKAGECONFIG.patch`](../patches/poky/systemd/0001-systemd-Add-homed-PACKAGECONFIG.patch) | [openembedded-core](https://git.openembedded.org/openembedded-core/) | [upstreamed](https://git.openembedded.org/openembedded-core/commit/?id=fff339b5bd7789db5d0c024fc84490ac17fa4fe9) | Fix QA issue when `repart`, `openssl` and `cryptsetup` are enabled |
| [`0001-cryptsetup-upgrade-2.3.5-2.3.6.patch`](../patches/meta-openembedded/misc/0001-cryptsetup-upgrade-2.3.5-2.3.6.patch) | [meta-openembedded](https://git.openembedded.org/meta-openembedded) | [cherry-picked](https://git.openembedded.org/meta-openembedded/commit/?id=056d0892f0e2d1eb30029dbe9810b0800e87e634) | Required for the next patch to apply cleanly |
| [`0001-cryptsetup-Add-runtime-dependency-on-lvm2-udevrules-.patch`](../patches/meta-openembedded/misc/0001-cryptsetup-Add-runtime-dependency-on-lvm2-udevrules-.patch) |  [meta-openembedded](https://git.openembedded.org/meta-openembedded) | [upstreamed](https://git.openembedded.org/meta-openembedded/commit/?id=9b02aa12203adc6219a6e0f8b114058e2487b59f) | Fix issue where `cryptsetup luksOpen`/[`systemd-repart`](https://www.freedesktop.org/software/systemd/man/systemd-repart.html) hangs forever |
